# RiskTrac GRC - Docker Compose
# Server: 10.0.1.32
# Access app at http://10.0.1.32:8080 (nginx). API ports: 6001 authapi, 6002 umapi, 6003 ormapi, 6004 bcmapi
# Docker Hub: vinod9072/imagename:v1
name: risktrac-grc

services:
  authapi:
    image: vinod9072/authapi:v1
    build:
      context: ./authapi
      dockerfile: Dockerfile
    container_name: risktrac-authapi
    ports:
      - "6001:6001"
    environment:
      - PORT=6001
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_USER=${DB_USER:-sqldev}
      - DB_SERVER=${DB_SERVER:-10.0.1.22}
      - DB_PORT=${DB_PORT:-1433}
      - DB_NAME=${DB_NAME:-SE_GRC}
    networks:
      - risktrac-net
    restart: unless-stopped

  umapi:
    image: vinod9072/umapi:v1
    build:
      context: ./umapi
      dockerfile: Dockerfile
    container_name: risktrac-umapi
    ports:
      - "6002:6002"
    environment:
      - PORT=6002
      - AUTH_SERVICE_URL=http://authapi:6001
      # Shared with ormapi/bcmapi so tokens verify (avoids "Session expired" in ORM/BCM)
      - JWT_SECRET=${JWT_SECRET:-risktrac-grc-shared-jwt-secret-key-min-32-chars}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_USER=${DB_USER:-sqldev}
      - DB_SERVER=${DB_SERVER:-10.0.1.22}
      - DB_PORT=${DB_PORT:-1433}
      - DB_NAME=${DB_NAME:-SE_GRC}
      - NOTIFICATION_DB_PASSWORD=${NOTIFICATION_DB_PASSWORD:-${DB_PASSWORD}}
      - NOTIFICATION_DB_SERVER=${NOTIFICATION_DB_SERVER:-${DB_SERVER:-10.0.1.22}}
      - NOTIFICATION_DB_PORT=${NOTIFICATION_DB_PORT:-${DB_PORT:-1433}}
      - NOTIFICATION_DB_NAME=${NOTIFICATION_DB_NAME:-${DB_NAME:-SE_GRC}}
    networks:
      - risktrac-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:6002/user-management/auth/get-key',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

  ormapi:
    image: vinod9072/ormapi:v1
    build:
      context: ./ormapi
      dockerfile: Dockerfile
    container_name: risktrac-ormapi
    ports:
      - "6003:6003"
    environment:
      # Must match umapi JWT_SECRET so tokens issued at login verify here (avoids "Session expired")
      - JWT_SECRET=${JWT_SECRET:-risktrac-grc-shared-jwt-secret-key-min-32-chars}
      - PORT=6003
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_USER=${DB_USER:-sqldev}
      - DB_SERVER=${DB_SERVER:-10.0.1.22}
      - DB_PORT=${DB_PORT:-1433}
      - DB_NAME=${DB_NAME:-SE_GRC}
      - NOTIFICATION_DB_PASSWORD=${NOTIFICATION_DB_PASSWORD:-${DB_PASSWORD}}
      - NOTIFICATION_DB_SERVER=${NOTIFICATION_DB_SERVER:-${DB_SERVER:-10.0.1.22}}
      - NOTIFICATION_DB_PORT=${NOTIFICATION_DB_PORT:-${DB_PORT:-1433}}
      - NOTIFICATION_DB_NAME=${NOTIFICATION_DB_NAME:-${DB_NAME:-SE_GRC}}
    networks:
      - risktrac-net
    restart: unless-stopped

  bcmapi:
    image: vinod9072/bcmapi:v1
    build:
      context: ./bcmapi
      dockerfile: Dockerfile
    container_name: risktrac-bcmapi
    ports:
      - "6004:6004"
    environment:
      # Must match umapi JWT_SECRET so tokens issued at login verify here (avoids "Session expired")
      - JWT_SECRET=${JWT_SECRET:-risktrac-grc-shared-jwt-secret-key-min-32-chars}
      - PORT=6004
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_USER=${DB_USER:-sqldev}
      - DB_SERVER=${DB_SERVER:-10.0.1.22}
      - DB_PORT=${DB_PORT:-1433}
      - DB_NAME=${DB_NAME:-SE_GRC}
      - NOTIFICATION_DB_PASSWORD=${NOTIFICATION_DB_PASSWORD:-${DB_PASSWORD}}
      - NOTIFICATION_DB_SERVER=${NOTIFICATION_DB_SERVER:-${DB_SERVER:-10.0.1.22}}
      - NOTIFICATION_DB_PORT=${NOTIFICATION_DB_PORT:-${DB_PORT:-1433}}
      - NOTIFICATION_DB_NAME=${NOTIFICATION_DB_NAME:-${DB_NAME:-SE_GRC}}
    networks:
      - risktrac-net
    restart: unless-stopped

  hostweb:
    image: vinod9072/hostweb:v1
    build:
      context: ./hostweb
      dockerfile: Dockerfile
    container_name: risktrac-hostweb
    networks:
      - risktrac-net
    restart: unless-stopped

  umweb:
    image: vinod9072/umweb:v1
    build:
      context: ./umweb
      dockerfile: Dockerfile
    container_name: risktrac-umweb
    networks:
      - risktrac-net
    restart: unless-stopped

  ormweb:
    image: vinod9072/ormweb:v1
    build:
      context: ./ormweb
      dockerfile: Dockerfile
    container_name: risktrac-ormweb
    networks:
      - risktrac-net
    restart: unless-stopped

  bcmweb:
    image: vinod9072/bcmweb:v1
    build:
      context: ./bcmweb
      dockerfile: Dockerfile
    container_name: risktrac-bcmweb
    networks:
      - risktrac-net
    restart: unless-stopped

  nginx:
    image: vinod9072/nginx:v1
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: risktrac-nginx
    ports:
      - "8080:80"
    depends_on:
      - authapi
      - umapi
      - ormapi
      - bcmapi
      - hostweb
      - umweb
      - ormweb
      - bcmweb
    networks:
      - risktrac-net
    restart: unless-stopped

networks:
  risktrac-net:
    driver: bridge
