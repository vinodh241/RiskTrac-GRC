# RiskTrac GRC - Single Nginx reverse proxy for all modules
# Server: 10.0.1.32
# APIs: 6001 authapi, 6002 umapi, 6003 ormapi, 6004 bcmapi

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /tmp/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /var/log/nginx/access.log main;
    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 512M;

    server {
        listen 80;
        server_name 10.0.1.32 localhost;
        resolver 127.0.0.11 valid=10s ipv6=off;

        # Use variables for upstream so resolver 127.0.0.11 is used (avoids stale IPs after container restart)
        set $backend_authapi authapi;
        set $backend_umapi umapi;
        set $backend_ormapi ormapi;
        set $backend_bcmapi bcmapi;
        set $backend_umweb umweb;
        set $backend_ormweb ormweb;
        set $backend_bcmweb bcmweb;
        set $backend_hostweb hostweb;

        # Auth API - 6001 (strip /authapi prefix for backend)
        location /authapi/ {
            rewrite ^/authapi(.*) $1 break;
            proxy_pass http://$backend_authapi:6001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # User Management API - 6002
        location /umapi/ {
            rewrite ^/umapi(.*) $1 break;
            proxy_pass http://$backend_umapi:6002;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # ORM API - 6003
        location /ormapi/ {
            rewrite ^/ormapi(.*) $1 break;
            proxy_pass http://$backend_ormapi:6003;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # BCM API - 6004
        location /bcmapi/ {
            rewrite ^/bcmapi(.*) $1 break;
            proxy_pass http://$backend_bcmapi:6004;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # User Management Web - /um/ (backend serves at root)
        location /um/ {
            rewrite ^/um(.*) $1 break;
            proxy_pass http://$backend_umweb:80;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ORM Web - /orm/
        location /orm/ {
            rewrite ^/orm(.*) $1 break;
            proxy_pass http://$backend_ormweb:80;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # BCM Web - /bcm/
        location /bcm/ {
            rewrite ^/bcm(.*) $1 break;
            proxy_pass http://$backend_bcmweb:80;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Host Web - root (pass full request URI so .js, .css, fonts are served correctly)
        location / {
            proxy_pass http://$backend_hostweb:80;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
