# RiskTrac GRC - Single Nginx reverse proxy for all modules
# Server: 10.0.1.32
# APIs: 6001 authapi, 6002 umapi, 6003 ormapi, 6004 bcmapi

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /tmp/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /var/log/nginx/access.log main;
    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 512M;

    # Upstream backends (APIs)
    upstream authapi_backend {
        server authapi:6001;
    }
    upstream umapi_backend {
        server umapi:6002;
    }
    upstream ormapi_backend {
        server ormapi:6003;
    }
    upstream bcmapi_backend {
        server bcmapi:6004;
    }

    # Upstream backends (Web apps)
    upstream hostweb_backend {
        server hostweb:80;
    }
    upstream umweb_backend {
        server umweb:80;
    }
    upstream ormweb_backend {
        server ormweb:80;
    }
    upstream bcmweb_backend {
        server bcmweb:80;
    }

    server {
        listen 80;
        server_name 10.0.1.32 localhost;

        # Auth API - 6001 (strip /authapi prefix for backend)
        location /authapi/ {
            rewrite ^/authapi/(.*) /$1 break;
            proxy_pass http://authapi_backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # User Management API - 6002
        location /umapi/ {
            rewrite ^/umapi/(.*) /$1 break;
            proxy_pass http://umapi_backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # ORM API - 6003
        location /ormapi/ {
            rewrite ^/ormapi/(.*) /$1 break;
            proxy_pass http://ormapi_backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # BCM API - 6004
        location /bcmapi/ {
            rewrite ^/bcmapi/(.*) /$1 break;
            proxy_pass http://bcmapi_backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # User Management Web - /um/ (backend serves at root)
        location /um/ {
            rewrite ^/um/(.*) /$1 break;
            proxy_pass http://umweb_backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ORM Web - /orm/
        location /orm/ {
            rewrite ^/orm/(.*) /$1 break;
            proxy_pass http://ormweb_backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        BCM Web - /bcm/
        location /bcm/ {
            rewrite ^/bcm/(.*) /$1 break;
            proxy_pass http://bcmweb_backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Host Web - root
        location / {
            proxy_pass http://hostweb_backend/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
